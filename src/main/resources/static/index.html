<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Desktop POC - Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .controls {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
        }

        .btn-success:hover:not(:disabled) {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
        }

        .btn-danger:hover:not(:disabled) {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4a5568;
        }

        .status-panel {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-pending {
            background: #fbd38d;
            color: #744210;
        }

        .status-provisioning {
            background: #90cdf4;
            color: #2c5282;
        }

        .status-starting {
            background: #90cdf4;
            color: #2c5282;
        }

        .status-waiting_for_ip {
            background: #90cdf4;
            color: #2c5282;
        }

        .status-configuring {
            background: #90cdf4;
            color: #2c5282;
        }

        .status-running {
            background: #9ae6b4;
            color: #22543d;
        }

        .status-stopping {
            background: #fbd38d;
            color: #744210;
        }

        .status-stopped {
            background: #cbd5e0;
            color: #2d3748;
        }

        .status-failed {
            background: #fc8181;
            color: #742a2a;
        }

        .status-deleted {
            background: #cbd5e0;
            color: #2d3748;
        }

        .status-info {
            margin-top: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .status-info p {
            margin: 5px 0;
            color: #4a5568;
            font-size: 14px;
        }

        .status-info strong {
            color: #2d3748;
        }

        .desktop-viewer {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .desktop-viewer h2 {
            margin-bottom: 15px;
            color: #333;
        }

        .iframe-container {
            position: relative;
            width: 100%;
            height: 600px;
            background: #f7fafc;
            border-radius: 5px;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #fff5f5;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .success-message {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }

        .demo-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.4);
            text-align: center;
            font-weight: 600;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        .demo-banner-icon {
            font-size: 20px;
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Demo Mode Banner (shown when running with mock profile) -->
        <div id="demoBanner" class="demo-banner hidden">
            <span class="demo-banner-icon">ðŸŽ­</span>
            DEMO MODE - Running with Mock Infrastructure (No Proxmox/Guacamole Required)
        </div>

        <div class="header">
            <h1>Cloud Desktop POC</h1>
            <p class="subtitle">Test Interface for Desktop Provisioning API</p>
        </div>

        <div class="controls">
            <h2 style="margin-bottom: 20px;">Desktop Management</h2>

            <div class="form-group">
                <label for="userId">User ID:</label>
                <input type="text" id="userId" placeholder="Enter user ID (e.g., testuser)" value="testuser">
            </div>

            <div class="form-group">
                <label for="desktopName">Desktop Name (Optional):</label>
                <input type="text" id="desktopName" placeholder="Leave empty for default name">
            </div>

            <div class="form-group">
                <label for="plan">Plan:</label>
                <select id="plan">
                    <option value="BASIC">BASIC (2 vCPU, 2GB RAM)</option>
                    <option value="STANDARD">STANDARD (4 vCPU, 4GB RAM)</option>
                    <option value="PREMIUM">PREMIUM (8 vCPU, 8GB RAM)</option>
                </select>
            </div>

            <div class="button-group">
                <button id="createBtn" class="btn-primary" onclick="createDesktop()">Create Desktop</button>
                <button id="statusBtn" class="btn-secondary" onclick="checkStatus()" disabled>Refresh Status</button>
                <button id="startBtn" class="btn-success" onclick="startDesktop()" disabled>Start Desktop</button>
                <button id="stopBtn" class="btn-danger" onclick="stopDesktop()" disabled>Stop Desktop</button>
                <button id="deleteBtn" class="btn-danger" onclick="deleteDesktop()" disabled>Delete Desktop</button>
                <button id="connectBtn" class="btn-primary" onclick="connectDesktop()" disabled>Show Connection</button>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>
            <div id="successMessage" class="success-message hidden"></div>
        </div>

        <div class="status-panel">
            <h2>Desktop Status</h2>
            <div id="statusContent">
                <p style="color: #718096;">No desktop created yet. Enter a User ID and click "Create Desktop" to begin.
                </p>
            </div>
        </div>

        <div id="desktopViewer" class="desktop-viewer hidden">
            <h2>Desktop Connection</h2>
            <div class="iframe-container">
                <iframe id="desktopFrame" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        let currentDesktopId = null;
        let statusCheckInterval = null;

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function updateButtons(status) {
            const createBtn = document.getElementById('createBtn');
            const statusBtn = document.getElementById('statusBtn');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const connectBtn = document.getElementById('connectBtn');

            if (!currentDesktopId) {
                createBtn.disabled = false;
                statusBtn.disabled = true;
                startBtn.disabled = true;
                stopBtn.disabled = true;
                deleteBtn.disabled = true;
                connectBtn.disabled = true;
                return;
            }

            createBtn.disabled = true;
            statusBtn.disabled = false;
            deleteBtn.disabled = false;

            if (status === 'RUNNING') {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                connectBtn.disabled = false;
            } else if (status === 'STOPPED') {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                connectBtn.disabled = true;
            } else {
                startBtn.disabled = true;
                stopBtn.disabled = true;
                connectBtn.disabled = true;
            }
        }

        function updateStatus(desktop) {
            const statusContent = document.getElementById('statusContent');
            const status = desktop.status;
            const statusClass = status.toLowerCase();

            let html = `
                <h3>
                    Desktop ID: ${desktop.id}
                    <span class="status-badge status-${statusClass}">${status}</span>
                </h3>
                <div class="status-info">
                    <p><strong>User:</strong> ${desktop.userId}</p>
                    <p><strong>Name:</strong> ${desktop.name}</p>
                    <p><strong>Plan:</strong> ${desktop.plan}</p>
                    <p><strong>CPU Cores:</strong> ${desktop.cpuCores}</p>
                    <p><strong>Memory:</strong> ${desktop.memoryMb} MB</p>
                    <p><strong>Status Message:</strong> ${desktop.statusMessage || 'N/A'}</p>
                    ${desktop.ipAddress ? `<p><strong>IP Address:</strong> ${desktop.ipAddress}</p>` : ''}
                    <p><strong>Created:</strong> ${new Date(desktop.createdAt).toLocaleString()}</p>
                    <p><strong>Updated:</strong> ${new Date(desktop.updatedAt).toLocaleString()}</p>
                </div>
            `;

            statusContent.innerHTML = html;
            updateButtons(status);

            // Auto-refresh status if desktop is in a transitional state
            if (['PENDING', 'PROVISIONING', 'STARTING', 'WAITING_FOR_IP', 'CONFIGURING', 'STOPPING'].includes(status)) {
                if (!statusCheckInterval) {
                    statusCheckInterval = setInterval(() => checkStatus(true), 3000);
                }
            } else {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
            }
        }

        async function createDesktop() {
            hideMessages();
            const userId = document.getElementById('userId').value.trim();
            const desktopName = document.getElementById('desktopName').value.trim();
            const plan = document.getElementById('plan').value;

            if (!userId) {
                showError('Please enter a User ID');
                return;
            }

            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.innerHTML = 'Creating... <span class="loading"></span>';

            try {
                const requestBody = { userId, plan };
                if (desktopName) {
                    requestBody.name = desktopName;
                }

                const response = await fetch('/api/v1/desktops', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (response.ok) {
                    currentDesktopId = result.data.id;
                    updateStatus(result.data);
                    showSuccess(result.message || 'Desktop created successfully!');
                } else {
                    showError(result.message || 'Failed to create desktop');
                    createBtn.disabled = false;
                    createBtn.textContent = 'Create Desktop';
                }
            } catch (error) {
                showError('Error: ' + error.message);
                createBtn.disabled = false;
                createBtn.textContent = 'Create Desktop';
            }
        }

        async function checkStatus(silent = false) {
            if (!currentDesktopId) return;

            try {
                const response = await fetch(`/api/v1/desktops/${currentDesktopId}`);
                const result = await response.json();

                if (response.ok) {
                    updateStatus(result.data);
                    if (!silent) {
                        showSuccess('Status refreshed');
                    }
                } else {
                    if (response.status === 404) {
                        showError('Desktop not found. It may have been deleted.');
                        currentDesktopId = null;
                        updateButtons(null);
                    } else {
                        showError(result.message || 'Failed to get status');
                    }
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        async function startDesktop() {
            if (!currentDesktopId) return;
            hideMessages();

            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = 'Starting... <span class="loading"></span>';

            try {
                const response = await fetch(`/api/v1/desktops/${currentDesktopId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok) {
                    updateStatus(result.data);
                    showSuccess(result.message || 'Desktop started successfully!');
                } else {
                    showError(result.message || 'Failed to start desktop');
                    startBtn.disabled = false;
                    startBtn.textContent = 'Start Desktop';
                }
            } catch (error) {
                showError('Error: ' + error.message);
                startBtn.disabled = false;
                startBtn.textContent = 'Start Desktop';
            }
        }

        async function stopDesktop() {
            if (!currentDesktopId) return;
            hideMessages();

            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = true;
            stopBtn.innerHTML = 'Stopping... <span class="loading"></span>';

            try {
                const response = await fetch(`/api/v1/desktops/${currentDesktopId}/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force: false })
                });

                const result = await response.json();

                if (response.ok) {
                    updateStatus(result.data);
                    showSuccess(result.message || 'Desktop stopped successfully!');
                    document.getElementById('desktopViewer').classList.add('hidden');
                } else {
                    showError(result.message || 'Failed to stop desktop');
                    stopBtn.disabled = false;
                    stopBtn.textContent = 'Stop Desktop';
                }
            } catch (error) {
                showError('Error: ' + error.message);
                stopBtn.disabled = false;
                stopBtn.textContent = 'Stop Desktop';
            }
        }

        async function deleteDesktop() {
            if (!currentDesktopId) return;

            if (!confirm('Are you sure you want to delete this desktop? This action cannot be undone.')) {
                return;
            }

            hideMessages();

            const deleteBtn = document.getElementById('deleteBtn');
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = 'Deleting... <span class="loading"></span>';

            try {
                const response = await fetch(`/api/v1/desktops/${currentDesktopId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess(result.message || 'Desktop deleted successfully!');
                    currentDesktopId = null;
                    document.getElementById('statusContent').innerHTML = '<p style="color: #718096;">Desktop deleted. Create a new one to continue.</p>';
                    document.getElementById('desktopViewer').classList.add('hidden');
                    updateButtons(null);
                    document.getElementById('createBtn').textContent = 'Create Desktop';
                } else {
                    showError(result.message || 'Failed to delete desktop');
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Delete Desktop';
                }
            } catch (error) {
                showError('Error: ' + error.message);
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete Desktop';
            }
        }

        async function connectDesktop() {
            if (!currentDesktopId) return;
            hideMessages();

            try {
                const response = await fetch(`/api/v1/desktops/${currentDesktopId}/connect`);
                const result = await response.json();

                if (response.ok) {
                    const connectionUrl = result.data.connectionUrl;
                    checkForMockConnection(connectionUrl);
                    document.getElementById('desktopFrame').src = connectionUrl;
                    document.getElementById('desktopViewer').classList.remove('hidden');
                    showSuccess('Desktop connection loaded. If you see a login screen, use the configured credentials.');
                } else {
                    showError(result.message || 'Failed to get connection URL');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        // Cleanup interval on page unload
        window.addEventListener('beforeunload', () => {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        });

        // Check if running in mock mode by checking connection URL pattern
        async function checkMockMode() {
            try {
                // Try to create and immediately check a test desktop to see if mock mode is active
                // We'll check the actuator health endpoint instead
                const response = await fetch('/actuator/health');
                if (response.ok) {
                    // If we can reach actuator, check if mock profile is active
                    // For now, we'll show the banner if connection URLs contain 'mock'
                    // This will be updated when we detect actual mock connections
                }
            } catch (error) {
                // Ignore errors
            }
        }

        // Show demo banner when connection URL contains 'mock'
        function checkForMockConnection(connectionUrl) {
            if (connectionUrl && connectionUrl.includes('mock=true')) {
                document.getElementById('demoBanner').classList.remove('hidden');
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            checkMockMode();
        });
    </script>
</body>

</html>